<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestão de Cursos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container py-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Gestão de Cursos</h2>
  </div>

  <!-- FORMULÁRIO DE CURSO -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 id="curso-form-title">Adicionar Curso</h5>
      <form id="curso-form">
        <div class="row g-3">
          <div class="col-md-5"><input type="text" id="curso-nome" class="form-control" placeholder="Nome do Curso" required /></div>
          <div class="col-md-5"><input type="text" id="curso-descricao" class="form-control" placeholder="Descrição" required /></div>
          <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </div>
        <input type="hidden" id="curso-id" />
        <button type="button" id="cancel-curso-edit" class="btn btn-secondary mt-2 d-none">Cancelar Edição</button>
      </form>
    </div>
  </div>

  <div id="curso-list" class="row"></div>

  <!-- FORMULÁRIO DE MÓDULO -->
  <hr />
  <h2>Gestão de Módulos</h2>
  <div class="card mb-4">
    <div class="card-body">
      <h5 id="modulo-form-title">Adicionar Módulo</h5>
      <form id="modulo-form">
        <div class="row g-3">
          <div class="col-md-3"><input type="text" id="modulo-nome" class="form-control" placeholder="Nome do Módulo" required /></div>
          <div class="col-md-4"><input type="text" id="modulo-descricao" class="form-control" placeholder="Descrição" required /></div>
          <div class="col-md-3">
            <select id="modulo-curso" class="form-select" required>
              <option value="">Selecione o Curso</option>
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </div>
        <input type="hidden" id="modulo-id" />
        <button type="button" id="cancel-modulo-edit" class="btn btn-secondary mt-2 d-none">Cancelar Edição</button>
      </form>
    </div>
  </div>

  <div id="modulo-list" class="row"></div>

</div>

<script>
  const BASE_URL = "https://joselazaroprince.pythonanywhere.com/api";
  const token = "SEU_TOKEN_JWT_FIXO_AQUI"; // Substitua pelo token JWT válido

  // ======================== CURSOS ========================
  async function fetchCursos() {
    const res = await fetch(`${BASE_URL}/cursos/`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    renderCursos(data);
  }

  function renderCursos(cursos) {
    const list = document.getElementById("curso-list");
    list.innerHTML = "";
    cursos.forEach(curso => {
      const col = document.createElement("div");
      col.className = "col-md-4";
      col.innerHTML = `
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h5>${curso.nome}</h5>
            <p>${curso.descricao}</p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-primary" onclick="editCurso(${curso.id}, '${curso.nome}', '${curso.descricao}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCurso(${curso.id})">Excluir</button>
            </div>
          </div>
        </div>`;
      list.appendChild(col);
    });
  }

  document.getElementById("curso-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("curso-nome").value;
    const descricao = document.getElementById("curso-descricao").value;
    const id = document.getElementById("curso-id").value;
    const method = id ? "PUT" : "POST";
    const url = id ? `${BASE_URL}/cursos/${id}/` : `${BASE_URL}/cursos/`;

    const res = await fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ nome, descricao }),
    });

    if (res.ok) {
      document.getElementById("curso-form").reset();
      document.getElementById("curso-id").value = "";
      document.getElementById("curso-form-title").textContent = "Adicionar Curso";
      document.getElementById("cancel-curso-edit").classList.add("d-none");
      fetchCursos();
      populateCursoSelect();
    }
  });

  function editCurso(id, nome, descricao) {
    document.getElementById("curso-id").value = id;
    document.getElementById("curso-nome").value = nome;
    document.getElementById("curso-descricao").value = descricao;
    document.getElementById("curso-form-title").textContent = "Editar Curso";
    document.getElementById("cancel-curso-edit").classList.remove("d-none");
  }

  document.getElementById("cancel-curso-edit").addEventListener("click", () => {
    document.getElementById("curso-form").reset();
    document.getElementById("curso-id").value = "";
    document.getElementById("curso-form-title").textContent = "Adicionar Curso";
    document.getElementById("cancel-curso-edit").classList.add("d-none");
  });

  async function deleteCurso(id) {
    if (!confirm("Deseja excluir este curso?")) return;
    await fetch(`${BASE_URL}/cursos/${id}/`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    fetchCursos();
  }

  // ======================== MÓDULOS ========================
  async function fetchModulos() {
    const res = await fetch(`${BASE_URL}/modulos/`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    renderModulos(data);
  }

  function renderModulos(modulos) {
    const list = document.getElementById("modulo-list");
    list.innerHTML = "";
    modulos.forEach(modulo => {
      const col = document.createElement("div");
      col.className = "col-md-4";
      col.innerHTML = `
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h5>${modulo.nome}</h5>
            <p>${modulo.descricao}</p>
            <p class="text-muted"><small>Curso ID: ${modulo.curso}</small></p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-primary" onclick="editModulo(${modulo.id}, '${modulo.nome}', '${modulo.descricao}', ${modulo.curso})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="deleteModulo(${modulo.id})">Excluir</button>
            </div>
          </div>
        </div>`;
      list.appendChild(col);
    });
  }

  async function populateCursoSelect() {
    const res = await fetch(`${BASE_URL}/cursos/`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const cursos = await res.json();
    const select = document.getElementById("modulo-curso");
    select.innerHTML = `<option value="">Selecione o Curso</option>`;
    cursos.forEach(curso => {
      select.innerHTML += `<option value="${curso.id}">${curso.nome}</option>`;
    });
  }

  document.getElementById("modulo-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("modulo-nome").value;
    const descricao = document.getElementById("modulo-descricao").value;
    const curso = document.getElementById("modulo-curso").value;
    const id = document.getElementById("modulo-id").value;
    const method = id ? "PUT" : "POST";
    const url = id ? `${BASE_URL}/modulos/${id}/` : `${BASE_URL}/modulos/`;

    const res = await fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ nome, descricao, curso }),
    });

    if (res.ok) {
      document.getElementById("modulo-form").reset();
      document.getElementById("modulo-id").value = "";
      document.getElementById("modulo-form-title").textContent = "Adicionar Módulo";
      document.getElementById("cancel-modulo-edit").classList.add("d-none");
      fetchModulos();
    }
  });

  function editModulo(id, nome, descricao, curso) {
    document.getElementById("modulo-id").value = id;
    document.getElementById("modulo-nome").value = nome;
    document.getElementById("modulo-descricao").value = descricao;
    document.getElementById("modulo-curso").value = curso;
    document.getElementById("modulo-form-title").textContent = "Editar Módulo";
    document.getElementById("cancel-modulo-edit").classList.remove("d-none");
  }

  document.getElementById("cancel-modulo-edit").addEventListener("click", () => {
    document.getElementById("modulo-form").reset();
    document.getElementById("modulo-id").value = "";
    document.getElementById("modulo-form-title").textContent = "Adicionar Módulo";
    document.getElementById("cancel-modulo-edit").classList.add("d-none");
  });

  async function deleteModulo(id) {
    if (!confirm("Deseja excluir este módulo?")) return;
    await fetch(`${BASE_URL}/modulos/${id}/`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    fetchModulos();
  }

  // Carregamento inicial
  window.onload = () => {
    fetchCursos();
    fetchModulos();
    populateCursoSelect();
  };
</script>
</body>
</html>
